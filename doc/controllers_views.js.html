<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/views.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/views.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* Die globalen Funktionen kommen von lib_view /*
/* global getCollection */
/* global getViews */
/* global updateView */
/* global drawCity */
'use strict';
/*jshint -W117 */
/**
 * @ngdoc function
 * @name datacityApp.controller:ViewsCtrl
 * @description
 * # ViewsCtrl
 * Controller of the datacityApp
 */
angular.module('datacityApp')
    .controller('ViewsCtrl', function($scope, $route, $routeParams, $log, $http, $rootScope, sharedLogin, AGGR, REST) {
        //Standardeinstellungen
        REST.setUsername(sharedLogin.getUsername());
        REST.setPassword(sharedLogin.getPassword());

        var database = "einstellungen";
        var collection = "ansichten";
        var baseurl = "https://pegenau.com:16392";

        var WEBGL_DIV = 'Stadt';

        var dbWithCollections = "prelife";

        /**
         *  Konstruktor für eine Ansicht
         */
        function View() {
            this.name = "Neue Ansicht";
            this.collID = $scope.collID;
            this.creator = sharedLogin.getUsername();
            this.timeOfCreation = Date.now();
            this.lastModifiedBy = sharedLogin.getUsername();
            this.timeOfLastModification = this.timeOfCreation;
            this.dimensions = {
                height: null,
                area: null,
                color: null
            };
            this.attributesOfCollection = [];
            this.attributes = getAttributesWithType($scope.collection.data._embedded['rh:doc']);
            this.metaData = {};
            this.aggregations = [];
            this.districts = [];
            this.districtType = 0; //"Keine Blöcke benutzen" ist voreingestellt
        }

        /**
         *  Konstruktor für eine Aggregation
         */
        function Aggregation() {
            this.groupOverField = null;
            this.aggregationOperations = [];
        }

        function District() {
            this.field = null;
        }

        $scope.addDistrict = function() {
            if (!$scope.chosenView.districts) {
                $scope.chosenView.districts = [];
            }
            $scope.chosenView.districts.push(new District());
        };

        $scope.deleteDistrict = function(arrayIndex) {
            $scope.chosenView.districts.splice(arrayIndex, 1);
        };

        $scope.numberOfAggregations = 0;

        $scope.addNewAggregation = function() {
            $scope.chosenView.aggregations.push(new Aggregation());
            $scope.numberOfAggregations += 1;
        };

        $scope.removeAggregation = function(arrayIndex) {
            $scope.chosenView.aggregations.splice(arrayIndex, 1);

            //Zur Sicherheit
            if ($scope.numberOfAggregations &lt;= 0) {
                alert("Es gibt &lt;= 0 Aggregationen?");
            } else {
                $scope.numberOfAggregations -= 1;
            }
        };

        // Initialisierung des Controllers
        $scope.collection = null;
        $scope.collID = null;
        $scope.views = null;
        $scope.numberOfViews = null;
        $scope.chosenView = null;
        $scope.loader = false;
        $scope.metaData = null;

        // Ein- &amp; Ausklappen der Panels (Schritt 1-4)
        $scope.showStep1 = false; // Daten reduzieren
        $scope.showStep2 = false; // Verbindungen
        $scope.showStep3 = false; // Blöcke
        $scope.showStep4 = false; // Dimensionen

        $scope.availableAggregationOperations = AGGR.availableAggregationOperations;

        /**
         * Setzt die Daten, damit die WebGL-Stadt gezeichnet werden kann
         */
        $scope.drawCity = function() {
            var view = $scope.chosenView;
            var relUrl = "/" + dbWithCollections + "/" + view.collID + REST.META_DATA_PART + "data";
            $scope.createAggregationForDisplay(function(response) {
                REST.callCollectionAggr(dbWithCollections, $scope.chosenView.collID, 'data', function(response) {
                    REST.getURL(relUrl, null, function(collection) {
                        view.dimensions.name = {
                            name: view.dimensionSettings.name.name
                        };
                        view.dimensions.height = view.dimensionSettings.height.name;
                        view.dimensions.area = view.dimensionSettings.area.name;
                        view.dimensions.color = view.dimensionSettings.color.name;
                        if (!collection.data._embedded) {
                            $log.error("Keine Datensätze erhalten! Bitte Filter anpassen");
                        } else {
                            drawCity(collection.data._embedded['rh:doc'], view, WEBGL_DIV);
                        }
                    });
                });
            });
        };

        /**
         * Holt die Ansichten und speichert sie im Controller-Scope
         */
        $scope.getViews = function() {
            REST.getViewsOfCollection($scope.collID, function(views) {
                $scope.views = views;
                $scope.numberOfViews = (views) ? count(views) : 0;
            });
        };

        /**
         * Speichert Änderungen an den Einstellungen der Ansicht
         */
        $scope.updateView = function() {
            //Wird für die Anzeige in Angular benötigt
            $scope.chosenView.lastModifiedBy = sharedLogin.getUsername();
            $scope.chosenView.timeOfLastModification = Date.now();

            REST.updateView($scope.chosenView, function() {
                $scope.getViews();
            });
            //Versteckt die beiden Buttons wieder
            $scope.dimform.$setPristine();
        };

        /**
         * Verwirft die Änderungen, die in dem Formular gemacht wurden
         */
        $scope.discardChanges = function() {
            $scope.chosenView = angular.copy($scope.originalView);
            $scope.dimform.$setPristine();
        };

        /**
         * Wählt bei Klick auf eine Ansicht diese aus
         */
        $scope.setChosenView = function(view) {
            if ($scope.chosenView === view) {
                $scope.chosenView = null;
            } else {
                $log.info(view);
                REST.getData(function(response) {
                    if (response.data) {
                        $scope.chosenView = response.data;
                        REST.getCollectionsMetaData(dbWithCollections, $scope.collID, function(metaData) {
                            $scope.chosenView.metaData = metaData;
                            //$scope.chosenView.attributes = getAttributesWithType($scope.collection.data._embedded['rh:doc']);
                        });
                    }
                }, database, collection, view._id);
            }
        };


        /**
         * Initialisierung
         */
        if ($routeParams.collID) {
            $scope.collID = $routeParams.collID;
            $scope.getViews();
            REST.getDocuments(dbWithCollections, $scope.collID, function(resp) {
                $scope.collection = resp;
            });

        }

        /**
         * löscht eine Ansicht
         * 
         * @param view Die Ansicht, die gelöscht werden soll
         */
        $scope.deleteView = function(view) {
            REST.deleteView(view, function(response) {
                $scope.getViews();
                $scope.chosenView = null;
            });
        };

        /**
         * Erstellt eine neue Ansicht zu einem Datensatz
         * 
         * @param collID Die ID des Datensatzes, zu dem die Ansicht hinzugefügt werden soll
         */
        $scope.newView = function() {
            var view = new View();
            REST.getCollectionsMetaData(dbWithCollections, $scope.collID, function(metaData) {
                //$scope.chosenView.attributes = getAttributesWithType($scope.collection.data._embedded['rh:doc']);
                view.attributes.forEach(function(element) {
                    var array = [];
                    if (element.type === 'number') {
                        array.push(parseFloat(metaData["min_" + element.name]));
                        array.push(parseFloat(metaData["max_" + element.name]));
                    } else {
                        array.push(0);
                        array.push(1);
                    }

                    element.numberValueFilter = array;
                });
                REST.createView(view, $scope.collID, function(response) {
                    $scope.getViews();
                    $log.info(response);
                    var url = response.config.url;
                    var array = url.split('/');
                    view._id = array[array.length - 1];
                    $scope.setChosenView(view);
                });
            });
        };

        /**
         * Konstruktor für eine Kopie einer neuen Ansicht
         * Übernimmt die ausgewählten Dimensionsn der alten Ansicht, jedoch mit anderen Namen, Ersteller, Datum etc
         */
        function ViewCopy(collID) {
            this.name = collID.name + " (Kopie)";
            this.collID = $scope.collID;
            this.creator = sharedLogin.getUsername();
            this.timeOfCreation = Date.now();
            this.lastModifiedBy = sharedLogin.getUsername();
            this.timeOfLastModification = this.timeOfCreation;
            this.dimensions = collID.dimensions;
        }

        /**
         * Erstellt eine Kopie der Ansicht, welche ausgewählt ist
         * 
         * @param collID Die ID des Datensatzes, der ausgewählt ist
         */
        $scope.copyView = function(collID) {
            var newView = new ViewCopy(collID);
            var url = baseurl + '/einstellungen/ansichten/' + newView.timeOfCreation;
            $http.put(url, newView).then(function(response) {
                $scope.getViews();
                console.log(response);
            });
        };

        /**
         * @param jstime JavaScriptTime
         * @return Schönere Darstellung der Zeit
         */
        $scope.jstimeToFormatedTime = function(jstime) {
            var d = new Date(jstime);
            return d.toLocaleDateString() + " " + d.toLocaleTimeString();
        };

        /**
         * Erzeugt einen Text zum Download der ausgewählten Ansicht als JSON-Datei
         */
        $scope.downloadJSON = function() {
            var data = $scope.chosenView;
            var json = JSON.stringify(data);
            var blob = new Blob([json], {
                type: "application/json"
            });
            var url = URL.createObjectURL(blob);

            var a = document.createElement('a');
            console.log($scope.chosenView);
            a.download = "Collection_" + $scope.chosenView.collID + " - Ansicht_" + $scope.chosenView.name + ".json";
            a.href = url;
            a.textContent = "Collection:" + $scope.chosenView.collID + " - Ansicht:" + $scope.chosenView.name + ".json";

            var myWindow = window.open("", "", "width=400, height=200");
            myWindow.document.write("&lt;div id='jsonDownload'>&lt;/div>");
            myWindow.document.getElementById('jsonDownload').appendChild(a);
        };


        $scope.createAggregationForDisplay = function(fn) {
            var view = $scope.chosenView;
            var stages = [];
            stages.push(AGGR.createLimitStage(AGGR.MAX_DOCUMENTS_FOR_AGGREGATION));
            stages.push(AGGR.projectStage(view.attributes));
            stages.push(AGGR.matchStage(view.attributes));

            if (view.districts.length > 0) {
                $log.info("Districts:");
                $log.info(view.districts);
                stages = stages.concat(AGGR.createDistrictAggregationStages(view.districts, view.attributes));
            }
            var aggr = AGGR.buildAggregationPipe(view.collID, stages);
            aggr = AGGR.mongoDBCodeToRESTHeart(aggr);
            REST.addAggregation(dbWithCollections, view.collID, aggr, function(response) {
                if (fn) {
                    fn(response);
                }
            });
        };

    });
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#$get">$get</a></li><li><a href="global.html#addAggregation">addAggregation</a></li><li><a href="global.html#availableAggregationOperations">availableAggregationOperations</a></li><li><a href="global.html#buildAggregationPipe">buildAggregationPipe</a></li><li><a href="global.html#callCollectionsMetaDataAggrURI">callCollectionsMetaDataAggrURI</a></li><li><a href="global.html#count">count</a></li><li><a href="global.html#createMetaDataAggregation">createMetaDataAggregation</a></li><li><a href="global.html#createView">createView</a></li><li><a href="global.html#datacityApp">datacityApp</a></li><li><a href="global.html#deleteCollection">deleteCollection</a></li><li><a href="global.html#deleteData">deleteData</a></li><li><a href="global.html#deleteView">deleteView</a></li><li><a href="global.html#ensureCollectionsMetaData">ensureCollectionsMetaData</a></li><li><a href="global.html#getAggregations">getAggregations</a></li><li><a href="global.html#getAttributesWithType">getAttributesWithType</a></li><li><a href="global.html#getCollections">getCollections</a></li><li><a href="global.html#getCollectionsMetaData">getCollectionsMetaData</a></li><li><a href="global.html#getCurrentETag">getCurrentETag</a></li><li><a href="global.html#getCurrentETagForRelURL">getCurrentETagForRelURL</a></li><li><a href="global.html#getData">getData</a></li><li><a href="global.html#getDatabases">getDatabases</a></li><li><a href="global.html#getDocument">getDocument</a></li><li><a href="global.html#getDocuments">getDocuments</a></li><li><a href="global.html#getLoggedIn">getLoggedIn</a></li><li><a href="global.html#getPassword">getPassword</a></li><li><a href="global.html#getType">getType</a></li><li><a href="global.html#getUsername">getUsername</a></li><li><a href="global.html#getViewsOfCollection">getViewsOfCollection</a></li><li><a href="global.html#hasCollectionAggregations">hasCollectionAggregations</a></li><li><a href="global.html#hasCollectionMetaData">hasCollectionMetaData</a></li><li><a href="global.html#login">login</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#matchStage">matchStage</a></li><li><a href="global.html#projectStage">projectStage</a></li><li><a href="global.html#setHTTP">setHTTP</a></li><li><a href="global.html#setLOG">setLOG</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Jan 20 2016 17:42:54 GMT+0100 (Mitteleuropäische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
